<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 550">
  <defs>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f8fafc;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#e2e8f0;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-10%" y="-10%" width="120%" height="130%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <marker id="arrowheadGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="800" height="550" fill="url(#bgGrad)" rx="12"/>

  <!-- Title -->
  <text x="400" y="30" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="600" fill="#1e293b" text-anchor="middle">Communication Flow (Vsock Protocol)</text>

  <!-- Participant boxes -->
  <rect x="60" y="50" width="100" height="40" rx="6" fill="url(#headerGrad)" filter="url(#shadow)"/>
  <text x="110" y="75" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="500" fill="white" text-anchor="middle">Client</text>

  <rect x="230" y="50" width="120" height="40" rx="6" fill="url(#headerGrad)" filter="url(#shadow)"/>
  <text x="290" y="75" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="500" fill="white" text-anchor="middle">infra.operator</text>

  <rect x="420" y="50" width="100" height="40" rx="6" fill="url(#headerGrad)" filter="url(#shadow)"/>
  <text x="470" y="75" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="500" fill="white" text-anchor="middle">Firecracker</text>

  <rect x="590" y="50" width="140" height="40" rx="6" fill="url(#headerGrad)" filter="url(#shadow)"/>
  <text x="660" y="68" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="500" fill="white" text-anchor="middle">infra.operator</text>
  <text x="660" y="82" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="500" fill="white" text-anchor="middle">guest</text>

  <!-- Lifelines -->
  <line x1="110" y1="90" x2="110" y2="520" stroke="#94a3b8" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="290" y1="90" x2="290" y2="520" stroke="#94a3b8" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="470" y1="90" x2="470" y2="520" stroke="#94a3b8" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="660" y1="90" x2="660" y2="520" stroke="#94a3b8" stroke-width="2" stroke-dasharray="5,5"/>

  <!-- Message 1: Execute code request -->
  <line x1="115" y1="120" x2="280" y2="120" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="197" y="112" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569" text-anchor="middle">Execute code request</text>

  <!-- Message 2: Start microVM -->
  <line x1="295" y1="150" x2="460" y2="150" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="377" y="142" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569" text-anchor="middle">Start microVM</text>

  <!-- Message 3: Boot (kernel + rootfs) -->
  <line x1="475" y1="180" x2="650" y2="180" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="562" y="172" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569" text-anchor="middle">Boot (kernel + rootfs)</text>

  <!-- Message 4: Self - Start vsock server -->
  <rect x="620" y="200" width="80" height="30" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
  <text x="660" y="212" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#92400e" text-anchor="middle">Start vsock</text>
  <text x="660" y="222" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#92400e" text-anchor="middle">port 5000</text>

  <!-- Message 5: Connect to vsock UDS -->
  <line x1="295" y1="260" x2="460" y2="260" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="377" y="252" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#475569" text-anchor="middle">Connect to vsock UDS</text>

  <!-- Message 6: CONNECT 5000 -->
  <line x1="295" y1="290" x2="650" y2="290" stroke="#10b981" stroke-width="2" marker-end="url(#arrowheadGreen)"/>
  <text x="472" y="282" font-family="monospace" font-size="10" fill="#047857" text-anchor="middle">CONNECT 5000\n</text>

  <!-- Message 7: OK 5000 -->
  <line x1="650" y1="320" x2="295" y2="320" stroke="#10b981" stroke-width="2" marker-end="url(#arrowheadGreen)"/>
  <text x="472" y="312" font-family="monospace" font-size="10" fill="#047857" text-anchor="middle">OK 5000\n</text>

  <!-- Message 8: Job JSON -->
  <line x1="295" y1="360" x2="650" y2="360" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowhead)"/>
  <rect x="380" y="345" width="180" height="22" rx="3" fill="#ede9fe"/>
  <text x="470" y="360" font-family="monospace" font-size="9" fill="#6d28d9" text-anchor="middle">[4-byte len][Job JSON]</text>

  <!-- Message 9: Execute code (self) -->
  <rect x="620" y="380" width="80" height="30" rx="4" fill="#dcfce7" stroke="#10b981" stroke-width="1"/>
  <text x="660" y="398" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#166534" text-anchor="middle">Execute code</text>

  <!-- Message 10: Result JSON -->
  <line x1="650" y1="430" x2="295" y2="430" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowhead)"/>
  <rect x="380" y="415" width="180" height="22" rx="3" fill="#ede9fe"/>
  <text x="470" y="430" font-family="monospace" font-size="9" fill="#6d28d9" text-anchor="middle">[4-byte len][Result JSON]</text>

  <!-- Message 11: ACPI Shutdown Signal -->
  <line x1="295" y1="470" x2="460" y2="470" stroke="#ef4444" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="377" y="462" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#dc2626" text-anchor="middle">Shutdown Signal</text>

  <!-- Message 12: Return result -->
  <line x1="280" y1="500" x2="115" y2="500" stroke="#10b981" stroke-width="2" marker-end="url(#arrowheadGreen)"/>
  <text x="197" y="492" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#047857" text-anchor="middle">Return result</text>
</svg>
