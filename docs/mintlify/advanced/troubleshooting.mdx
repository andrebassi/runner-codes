---
title: 'Troubleshooting'
description: 'Common issues and their solutions'
---

## Quick Diagnostics

Run these commands to quickly diagnose issues:

```bash
# Check Firecracker process
ps aux | grep firecracker

# Check KVM availability
ls -la /dev/kvm

# Check vhost_vsock
ls -la /dev/vhost-vsock

# Check vsock socket exists
ls -la /tmp/fc-*.vsock

# View Firecracker logs
journalctl -u firecracker -f
```

## Common Issues

### VM Won't Start

<AccordionGroup>
  <Accordion title="KVM not available">
    **Error:**
    ```
    Error creating VM: cannot create KVM instance
    ```

    **Cause:** KVM module not loaded or no access to /dev/kvm

    **Solution:**
    ```bash
    # Load KVM module
    sudo modprobe kvm
    sudo modprobe kvm_intel  # or kvm_amd

    # Check permissions
    ls -la /dev/kvm
    # Should be: crw-rw---- 1 root kvm

    # Add user to kvm group
    sudo usermod -aG kvm $USER
    # Logout and login again
    ```
  </Accordion>

  <Accordion title="vhost_vsock not available">
    **Error:**
    ```
    Error configuring vsock: cannot open /dev/vhost-vsock
    ```

    **Cause:** vhost_vsock module not loaded

    **Solution:**
    ```bash
    # Load vhost_vsock module
    sudo modprobe vhost_vsock

    # Verify
    ls -la /dev/vhost-vsock
    # Should be: crw-rw---- 1 root kvm

    # Make permanent
    echo "vhost_vsock" | sudo tee -a /etc/modules
    ```
  </Accordion>

  <Accordion title="Kernel not found">
    **Error:**
    ```
    Error: cannot open kernel file: /srv/firecracker/vmlinux
    ```

    **Solution:**
    ```bash
    # Download kernel
    task s3:download

    # Verify
    ls -la /srv/firecracker/images/vmlinux
    ```
  </Accordion>

  <Accordion title="Rootfs not found">
    **Error:**
    ```
    Error: cannot open drive file: /srv/firecracker/rootfs.ext4
    ```

    **Solution:**
    ```bash
    # Download rootfs images
    task s3:download

    # Verify
    ls -la /srv/firecracker/images/rootfs-*.ext4
    ```
  </Accordion>

  <Accordion title="Socket already in use">
    **Error:**
    ```
    Error: cannot bind to socket /tmp/fc-12345.sock: Address already in use
    ```

    **Solution:**
    ```bash
    # Find and kill existing Firecracker process
    ps aux | grep firecracker
    kill -9 <PID>

    # Remove stale sockets
    rm -f /tmp/fc-*.sock /tmp/fc-*.vsock

    # Retry
    ```
  </Accordion>
</AccordionGroup>

### Connection Issues

<AccordionGroup>
  <Accordion title="Cannot connect to vsock">
    **Error:**
    ```
    dial unix /tmp/fc-12345.vsock: no such file or directory
    ```

    **Causes:**
    1. VM not started
    2. vsock not configured
    3. Wrong socket path

    **Solution:**
    ```bash
    # Verify VM is running
    ps aux | grep firecracker

    # Check vsock was configured
    curl --unix-socket /tmp/fc-12345.sock \
      http://localhost/vsock 2>/dev/null | jq

    # Verify socket exists
    ls -la /tmp/fc-12345.vsock
    ```
  </Accordion>

  <Accordion title="CONNECT refused (NO response)">
    **Error:**
    ```
    NO 5000
    ```

    **Causes:**
    1. infra.operator (guest mode) not started
    2. Wrong port number
    3. VM not fully booted

    **Solution:**
    ```bash
    # Wait longer for VM to boot
    sleep 5

    # Check if infra.operator is listening (via serial console)
    # Look for: "Listening on vsock CID=3, port=5000"

    # Verify port number matches
    # Host: CONNECT 5000
    # Guest: vsock.Listen(3, 5000)
    ```
  </Accordion>

  <Accordion title="Connection timeout">
    **Error:**
    ```
    read: deadline exceeded
    ```

    **Causes:**
    1. infra.operator (guest mode) crashed
    2. Code execution taking too long
    3. Deadlock in guest

    **Solution:**
    ```bash
    # Increase timeout
    job := Job{
        Timeout: 60,  // Increase from default
    }

    # Check serial console for guest errors
    # Guest may have panicked or OOM'd

    # Check if VM is still running
    curl --unix-socket /tmp/fc.sock http://localhost/
    ```
  </Accordion>
</AccordionGroup>

### Execution Errors

<AccordionGroup>
  <Accordion title="Execution timeout">
    **Error:**
    ```json
    {
      "exit_code": -1,
      "error": "execution timeout"
    }
    ```

    **Causes:**
    1. Infinite loop in code
    2. Timeout too short
    3. Heavy computation

    **Solution:**
    ```go
    // Increase timeout for heavy computations
    job := Job{
        Code:    "heavy_computation()",
        Timeout: 60,  // seconds
    }

    // Or check code for infinite loops
    ```
  </Accordion>

  <Accordion title="Out of memory">
    **Error:**
    ```json
    {
      "exit_code": 137,
      "stderr": "Killed"
    }
    ```

    **Cause:** Code exceeded memory limit

    **Solution:**
    ```json
    // Increase VM memory
    {
      "vcpu_count": 1,
      "mem_size_mib": 1024  // Increase from 512
    }
    ```
  </Accordion>

  <Accordion title="Language not found">
    **Error:**
    ```json
    {
      "exit_code": 127,
      "stderr": "python3: command not found"
    }
    ```

    **Cause:** Wrong rootfs or language not installed

    **Solution:**
    ```bash
    # Verify using correct rootfs
    ls -la /srv/firecracker/images/rootfs-python.ext4

    # Mount and check contents
    sudo mount -o loop rootfs-python.ext4 /mnt
    ls /mnt/usr/bin/python3
    sudo umount /mnt
    ```
  </Accordion>

  <Accordion title="Permission denied">
    **Error:**
    ```json
    {
      "exit_code": 126,
      "stderr": "permission denied"
    }
    ```

    **Cause:** Script file not executable

    **Solution:**
    ```go
    // In infra.operator guest, ensure chmod after writing
    err := os.WriteFile(scriptPath, []byte(code), 0755)
    ```
  </Accordion>
</AccordionGroup>

### Build Errors

<AccordionGroup>
  <Accordion title="Cross-compilation fails">
    **Error:**
    ```
    cannot find package syscall (using -tags vsock)
    ```

    **Solution:**
    ```bash
    # Use correct build tags
    GOOS=linux GOARCH=amd64 CGO_ENABLED=0 \
      go build -o bin/infra.operator-linux ./cmd/infra.operator
    ```
  </Accordion>

  <Accordion title="Binary not compatible">
    **Error:**
    ```
    cannot execute binary file: Exec format error
    ```

    **Cause:** Wrong architecture

    **Solution:**
    ```bash
    # Build for correct architecture
    # For x86_64:
    GOOS=linux GOARCH=amd64 go build -o bin/infra.operator-linux ./cmd/infra.operator

    # For ARM64:
    GOOS=linux GOARCH=arm64 go build -o bin/infra.operator-arm64 ./cmd/infra.operator

    # Verify binary
    file bin/infra.operator-linux
    # Should show: ELF 64-bit LSB executable, x86-64
    ```
  </Accordion>
</AccordionGroup>

### S3 Issues

<AccordionGroup>
  <Accordion title="Access denied">
    **Error:**
    ```
    An error occurred (AccessDenied) when calling the GetObject operation
    ```

    **Solution:**
    ```bash
    # Check AWS credentials
    aws sts get-caller-identity

    # Verify bucket policy allows access
    aws s3 ls s3://llm-infra-operator-rootfs/

    # Check IAM policy
    aws iam get-user-policy --user-name <user> --policy-name <policy>
    ```
  </Accordion>

  <Accordion title="Bucket not found">
    **Error:**
    ```
    An error occurred (NoSuchBucket) when calling the ListObjects operation
    ```

    **Solution:**
    ```bash
    # Create bucket
    aws s3 mb s3://llm-infra-operator-rootfs --region us-east-1

    # Verify
    aws s3 ls
    ```
  </Accordion>
</AccordionGroup>

## Debug Commands

### Check VM Status

```bash
# Via Firecracker API
curl --unix-socket /tmp/fc.sock http://localhost/ | jq
curl --unix-socket /tmp/fc.sock http://localhost/machine-config | jq
curl --unix-socket /tmp/fc.sock http://localhost/vsock | jq
```

### Monitor Serial Console

```bash
# View serial console output
# Add console=ttyS0 to boot args
# Then:
screen /dev/pts/X
```

### Test vsock Connection

```bash
# Manual vsock test
exec 3<>/dev/tcp/localhost/5000 || echo "Failed"

# Or with netcat
echo -e "CONNECT 5000\n" | nc -U /tmp/fc-12345.vsock
```

### Check Guest Status

```bash
# Connect to vsock and send test job
{
  echo "CONNECT 5000"
  sleep 0.5
  echo -ne '\x00\x00\x00\x2B{"trace_id":"test","lang":"bash","code":"echo OK","timeout":10}'
} | nc -U /tmp/fc-12345.vsock
```

## Log Locations

| Component | Log Location |
|-----------|--------------|
| infra.operator (host) | stdout / systemd journal |
| Firecracker | stderr / serial console |
| infra.operator (guest) | /var/log/infra.operator.log (in VM) |
| System | /var/log/syslog |

### Enable Debug Logging

```go
// infra.operator host
log.SetLevel(log.DebugLevel)

// infra.operator guest
log.SetLevel(log.DebugLevel)
```

### Firecracker Debug Mode

```bash
# Start with log file
firecracker --api-sock /tmp/fc.sock \
  --log-path /var/log/firecracker.log \
  --level Debug
```

## Health Checks

### Automated Health Check

```bash
#!/bin/bash
# health-check.sh

# Check KVM
if [ ! -c /dev/kvm ]; then
    echo "FAIL: /dev/kvm not available"
    exit 1
fi

# Check vhost_vsock
if [ ! -c /dev/vhost-vsock ]; then
    echo "FAIL: /dev/vhost-vsock not available"
    exit 1
fi

# Check images
if [ ! -f /srv/firecracker/images/vmlinux ]; then
    echo "FAIL: kernel not found"
    exit 1
fi

# Check rootfs images
for lang in python nodejs go rust bash; do
    if [ ! -f /srv/firecracker/images/rootfs-${lang}.ext4 ]; then
        echo "FAIL: rootfs-${lang}.ext4 not found"
        exit 1
    fi
done

# Check disk space
FREE=$(df /srv -m | tail -1 | awk '{print $4}')
if [ "$FREE" -lt 5000 ]; then
    echo "WARN: Low disk space: ${FREE}MB"
fi

echo "OK: All checks passed"
```

### Run Health Check

```bash
task aws:healthcheck
# Or manually:
./health-check.sh
```

## Getting Help

If you're stuck:

1. **Check logs first**: Most issues are visible in logs
2. **Reproduce minimally**: Find the smallest failing case
3. **Check documentation**: Review relevant docs pages
4. **Search issues**: Check GitHub issues for similar problems
5. **Open issue**: If nothing helps, open a new issue with:
   - Error message
   - Steps to reproduce
   - Environment details
   - Relevant logs

## Quick Fixes Cheatsheet

| Problem | Quick Fix |
|---------|-----------|
| VM won't start | `sudo modprobe kvm kvm_intel vhost_vsock` |
| Socket in use | `rm -f /tmp/fc-*.sock /tmp/fc-*.vsock` |
| vsock refused | Wait longer, check infra.operator service |
| Timeout | Increase timeout, check for loops |
| OOM | Increase `mem_size_mib` |
| Wrong rootfs | Check language â†’ rootfs mapping |
| S3 access denied | Check AWS credentials |
| Binary format | Cross-compile with correct GOARCH |
