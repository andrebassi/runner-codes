# LLM-FireSandbox: Technical Architecture

## Table of Contents

1. [Overview](#overview)
2. [System Architecture](#system-architecture)
3. [Component Deep Dive](#component-deep-dive)
4. [Communication Protocols](#communication-protocols)
5. [Firecracker Integration](#firecracker-integration)
6. [Security Model](#security-model)
7. [Performance Considerations](#performance-considerations)
8. [Memory Layout](#memory-layout)
9. [Execution Flow](#execution-flow)

---

## Overview

LLM-FireSandbox is a secure code execution environment designed to run untrusted code generated by Large Language Models (LLMs) in isolated Firecracker microVMs. The system provides hardware-level isolation through KVM virtualization while maintaining low latency through vsock communication.

### Design Goals

1. **Strong Isolation**: Hardware-level isolation via KVM/Firecracker
2. **Low Latency**: Sub-second cold start, millisecond warm start with snapshots
3. **Multi-language Support**: Python, Node.js, Rust, Ruby, Go, Bash
4. **Minimal Attack Surface**: No network, minimal syscalls, seccomp filtering
5. **Observability**: Tracing via trace_id propagation

---

## System Architecture

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              HOST SYSTEM                                 │
│  ┌─────────────────┐                                                    │
│  │  Control Plane  │  (Future: API Gateway, Queue, Scheduler)           │
│  │   (Optional)    │                                                    │
│  └────────┬────────┘                                                    │
│           │ gRPC/HTTP                                                   │
│           ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        HOST-AGENT (Go)                           │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │   │
│  │  │ Firecracker  │  │    Vsock     │  │   Instance Manager   │   │   │
│  │  │   Client     │  │   Client     │  │   (Pool, Lifecycle)  │   │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────────────────────┘   │   │
│  └─────────┼─────────────────┼──────────────────────────────────────┘   │
│            │                 │                                          │
│            │ HTTP over       │ AF_VSOCK                                 │
│            │ Unix Socket     │ (virtio-vsock)                           │
│            ▼                 │                                          │
│  ┌──────────────────┐        │                                          │
│  │   Firecracker    │        │                                          │
│  │    Process       │        │                                          │
│  │  /tmp/fc-X.sock  │        │                                          │
│  └────────┬─────────┘        │                                          │
│           │                  │                                          │
│           │ VMM              │                                          │
│           ▼                  ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                     FIRECRACKER microVM                           │  │
│  │  ┌────────────────────────────────────────────────────────────┐  │  │
│  │  │                     GUEST KERNEL                            │  │  │
│  │  │  (vmlinux - minimal Linux kernel with virtio drivers)       │  │  │
│  │  └────────────────────────────────────────────────────────────┘  │  │
│  │  ┌────────────────────────────────────────────────────────────┐  │  │
│  │  │                    GUEST USERSPACE                          │  │  │
│  │  │  ┌─────────────────────────────────────────────────────┐   │  │  │
│  │  │  │              GUEST-RUNNER (Go binary)                │   │  │  │
│  │  │  │  ┌───────────┐  ┌───────────┐  ┌────────────────┐   │   │  │  │
│  │  │  │  │  Vsock    │  │ Executor  │  │   Sandboxed    │   │   │  │  │
│  │  │  │  │ Listener  │  │  Engine   │  │   Processes    │   │  │  │  │
│  │  │  │  │ port 5000 │  │           │  │ python/node/..│   │  │  │  │
│  │  │  │  └───────────┘  └───────────┘  └────────────────┘   │   │  │  │
│  │  │  └─────────────────────────────────────────────────────┘   │  │  │
│  │  └────────────────────────────────────────────────────────────┘  │  │
│  │                                                                   │  │
│  │  Resources: 1 vCPU, 512 MiB RAM, virtio-blk (rootfs)             │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  Kernel Interfaces: /dev/kvm, /dev/vhost_vsock                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Component Interaction Sequence

```
┌──────────┐     ┌───────────┐     ┌─────────────┐     ┌─────────────┐
│  Client  │     │HostAgent  │     │ Firecracker │     │GuestRunner  │
└────┬─────┘     └─────┬─────┘     └──────┬──────┘     └──────┬──────┘
     │                 │                  │                   │
     │ RunRequest      │                  │                   │
     │────────────────>│                  │                   │
     │                 │                  │                   │
     │                 │ PUT /machine-config                  │
     │                 │─────────────────>│                   │
     │                 │       200 OK     │                   │
     │                 │<─────────────────│                   │
     │                 │                  │                   │
     │                 │ PUT /boot-source │                   │
     │                 │─────────────────>│                   │
     │                 │       200 OK     │                   │
     │                 │<─────────────────│                   │
     │                 │                  │                   │
     │                 │ PUT /drives/rootfs                   │
     │                 │─────────────────>│                   │
     │                 │       200 OK     │                   │
     │                 │<─────────────────│                   │
     │                 │                  │                   │
     │                 │ PUT /vsock       │                   │
     │                 │─────────────────>│                   │
     │                 │       200 OK     │                   │
     │                 │<─────────────────│                   │
     │                 │                  │                   │
     │                 │ PUT /actions     │                   │
     │                 │ {InstanceStart}  │                   │
     │                 │─────────────────>│                   │
     │                 │       200 OK     │  Boot VM          │
     │                 │<─────────────────│──────────────────>│
     │                 │                  │                   │
     │                 │                  │    vsock.Listen() │
     │                 │                  │<──────────────────│
     │                 │                  │                   │
     │                 │ vsock.Dial(CID=3, port=5000)         │
     │                 │─────────────────────────────────────>│
     │                 │                  │                   │
     │                 │ JSON {lang, code, timeout}           │
     │                 │─────────────────────────────────────>│
     │                 │                  │                   │
     │                 │                  │   exec(python3)   │
     │                 │                  │   ─────────────>  │
     │                 │                  │   stdout/stderr   │
     │                 │                  │   <─────────────  │
     │                 │                  │                   │
     │                 │ JSON {stdout, stderr, exit_code}     │
     │                 │<─────────────────────────────────────│
     │                 │                  │                   │
     │ RunResult       │                  │                   │
     │<────────────────│                  │                   │
     │                 │                  │                   │
     │                 │ PUT /actions     │                   │
     │                 │ {SendCtrlAltDel} │                   │
     │                 │─────────────────>│  Shutdown         │
     │                 │       200 OK     │──────────────────>│
     │                 │<─────────────────│                   │
     │                 │                  │                   │
```

---

## Component Deep Dive

### Host-Agent

The Host-Agent is the orchestrator running on the host system. It manages Firecracker instances and communicates with guests via vsock.

#### Module Structure

```
host-agent/
├── main.go           # Entry point, CLI parsing, orchestration
├── types.go          # Data structures (RunRequest, RunResult, configs)
├── firecracker.go    # Firecracker API client (HTTP over Unix socket)
└── vsock.go          # Vsock client for guest communication
```

#### Firecracker Client Architecture

```go
// FirecrackerClient wraps HTTP client with Unix socket transport
type FirecrackerClient struct {
    socketPath string
    client     *http.Client  // Custom transport for Unix socket
}

// Transport configuration
transport := &http.Transport{
    DialContext: func(_ context.Context, _, _ string) (net.Conn, error) {
        return net.Dial("unix", socketPath)  // Connect to Firecracker socket
    },
}
```

#### API Endpoints Used

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/machine-config` | PUT | Set vCPUs, memory, HT |
| `/boot-source` | PUT | Set kernel path, boot args |
| `/drives/{id}` | PUT | Attach block devices |
| `/vsock` | PUT | Configure vsock device |
| `/actions` | PUT | Start/stop instance |
| `/snapshot/create` | PUT | Create VM snapshot |
| `/snapshot/load` | PUT | Restore from snapshot |

#### Vsock Client

```go
// Vsock communication uses AF_VSOCK socket family
// CID (Context ID) identifies the VM, Port identifies the service

const (
    VMADDR_CID_HOST  = 2  // Host CID (reserved)
    VMADDR_CID_GUEST = 3  // Default guest CID in Firecracker
)

// Connection establishment
conn, err := vsock.Dial(guestCID, port, nil)
// guestCID = 3 (Firecracker default)
// port = 5000 (GuestRunner listener)
```

### Guest-Runner

The Guest-Runner is a statically compiled Go binary that runs inside the microVM. It listens for jobs via vsock and executes code in isolated processes.

#### Module Structure

```
guest-runner/
├── main.go           # Vsock listener, connection handler
├── types.go          # Job and Result structures
└── executor.go       # Language-specific execution logic
```

#### Executor Engine

```go
type Executor struct {
    languages map[string]LanguageConfig
}

type LanguageConfig struct {
    Name       string   // "python", "node", etc.
    Extension  string   // ".py", ".js", etc.
    Command    string   // "python3", "node", etc.
    Args       []string // Additional arguments
    NeedsBuild bool     // true for compiled languages
    BuildCmd   string   // "rustc", "go build", etc.
    BuildArgs  []string // Build arguments
}
```

#### Execution Flow

```
1. Receive Job via vsock
       │
       ▼
2. Create temp directory (/tmp/job-XXXXX/)
       │
       ▼
3. Write code to file (script.py, script.js, etc.)
       │
       ▼
4. If compiled language:
   │   └── Run compiler (rustc, go build)
   │       └── On error: return compile error
   │
   ▼
5. Execute with timeout (context.WithTimeout)
       │
       ▼
6. Capture stdout, stderr, exit code
       │
       ▼
7. Cleanup temp directory
       │
       ▼
8. Return Result via vsock
```

#### Process Isolation (per execution)

```
┌─────────────────────────────────────────────────────────────┐
│                    GUEST-RUNNER PROCESS                      │
│                      (PID 1 or init)                         │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   VSOCK LISTENER                       │  │
│  │                   goroutine pool                       │  │
│  └───────────────────────────────────────────────────────┘  │
│           │                    │                    │        │
│           ▼                    ▼                    ▼        │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐  │
│  │  Handler 1  │      │  Handler 2  │      │  Handler N  │  │
│  │  goroutine  │      │  goroutine  │      │  goroutine  │  │
│  └──────┬──────┘      └──────┬──────┘      └──────┬──────┘  │
│         │                    │                    │          │
│         ▼                    ▼                    ▼          │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐  │
│  │ python3     │      │ node        │      │ rustc/run   │  │
│  │ subprocess  │      │ subprocess  │      │ subprocess  │  │
│  │ /tmp/job-1/ │      │ /tmp/job-2/ │      │ /tmp/job-3/ │  │
│  └─────────────┘      └─────────────┘      └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Communication Protocols

### Vsock (Virtual Socket)

Vsock provides a communication channel between host and guest without requiring network configuration.

#### Socket Address Family

```
┌─────────────────────────────────────────────────────────────┐
│                    AF_VSOCK Address                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  struct sockaddr_vm {                                │    │
│  │      sa_family_t    svm_family;    // AF_VSOCK      │    │
│  │      unsigned short svm_reserved1;                   │    │
│  │      unsigned int   svm_port;      // Service port  │    │
│  │      unsigned int   svm_cid;       // Context ID    │    │
│  │      ...                                             │    │
│  │  };                                                  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Reserved CIDs:                                              │
│    VMADDR_CID_ANY       = -1  (0xFFFFFFFF)                  │
│    VMADDR_CID_HYPERVISOR = 0                                 │
│    VMADDR_CID_LOCAL      = 1  (loopback)                    │
│    VMADDR_CID_HOST       = 2  (host system)                 │
│    VMADDR_CID_GUEST      = 3+ (guest VMs)                   │
└─────────────────────────────────────────────────────────────┘
```

#### Kernel Modules Required

```bash
# Host kernel modules
/dev/kvm           # KVM hypervisor interface
/dev/vhost_vsock   # Vhost vsock backend

# Load modules
modprobe kvm
modprobe kvm_intel  # or kvm_amd
modprobe vhost_vsock

# Guest kernel config (compiled into vmlinux)
CONFIG_VIRTIO_VSOCKETS=y
CONFIG_VIRTIO_VSOCKETS_COMMON=y
```

### Wire Protocol (JSON over Vsock)

```
┌─────────────────────────────────────────────────────────────┐
│                    REQUEST FORMAT                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  {                                                   │    │
│  │    "trace_id": "tr-1234567890",   // Tracing ID     │    │
│  │    "lang": "python",               // Language      │    │
│  │    "code": "print('hello')",       // Source code   │    │
│  │    "timeout": 10,                  // Seconds       │    │
│  │    "meta": {                       // Optional      │    │
│  │      "user_id": "u-123",                            │    │
│  │      "request_id": "req-456"                        │    │
│  │    }                                                 │    │
│  │  }                                                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│                    RESPONSE FORMAT                           │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  {                                                   │    │
│  │    "trace_id": "tr-1234567890",   // Echo trace_id  │    │
│  │    "stdout": "hello\n",            // Standard out  │    │
│  │    "stderr": "",                   // Standard err  │    │
│  │    "exit_code": 0,                 // Process exit  │    │
│  │    "error": ""                     // System error  │    │
│  │  }                                                   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## Firecracker Integration

### Firecracker Process Model

```
┌─────────────────────────────────────────────────────────────┐
│                    HOST PROCESS TREE                         │
│                                                              │
│  host-agent (Go)                                             │
│       │                                                      │
│       ├── firecracker --api-sock /tmp/fc-123.sock           │
│       │       │                                              │
│       │       └── [KVM vCPU threads]                        │
│       │                                                      │
│       └── (optional) jailer wrapper for production          │
│               │                                              │
│               └── firecracker (chrooted, unprivileged)      │
└─────────────────────────────────────────────────────────────┘
```

### Firecracker API Configuration Sequence

```
1. Machine Configuration
   PUT /machine-config
   {
     "vcpu_count": 1,
     "mem_size_mib": 512,
     "ht_enabled": false
   }

2. Boot Source
   PUT /boot-source
   {
     "kernel_image_path": "/srv/firecracker/vmlinux",
     "boot_args": "console=ttyS0 reboot=k panic=1 pci=off root=/dev/vda1 rw"
   }

3. Root Drive
   PUT /drives/rootfs
   {
     "drive_id": "rootfs",
     "path_on_host": "/srv/firecracker/rootfs.ext4",
     "is_root_device": true,
     "is_read_only": false
   }

4. Vsock Device
   PUT /vsock
   {
     "guest_cid": 3,
     "uds_path": "/tmp/fc-123.vsock"
   }

5. Start Instance
   PUT /actions
   {
     "action_type": "InstanceStart"
   }
```

### Boot Arguments Explained

```
console=ttyS0      # Serial console output (for debugging)
reboot=k           # Use keyboard controller for reboot
panic=1            # Reboot after 1 second on kernel panic
pci=off            # Disable PCI bus (not needed for virtio)
root=/dev/vda1     # Root filesystem on first virtio-blk partition
rw                 # Mount root filesystem read-write
init=/sbin/init    # (optional) Specify init process
quiet              # (optional) Reduce kernel messages
```

### Virtio Device Mapping

```
┌─────────────────────────────────────────────────────────────┐
│                    VIRTIO DEVICES                            │
│                                                              │
│  ┌─────────────────┐   ┌─────────────────┐                  │
│  │  virtio-blk     │   │  virtio-vsock   │                  │
│  │  /dev/vda       │   │  AF_VSOCK       │                  │
│  │  (rootfs.ext4)  │   │  CID=3          │                  │
│  └────────┬────────┘   └────────┬────────┘                  │
│           │                     │                            │
│           ▼                     ▼                            │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              GUEST KERNEL (vmlinux)                  │    │
│  │  Drivers: virtio_blk, virtio_vsock, virtio_net (opt)│    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  Optional devices:                                           │
│  - virtio-net (if network needed)                           │
│  - virtio-rng (random number generator)                     │
│  - virtio-balloon (memory ballooning)                       │
└─────────────────────────────────────────────────────────────┘
```

---

## Security Model

### Isolation Layers

```
┌─────────────────────────────────────────────────────────────┐
│  LAYER 1: HARDWARE VIRTUALIZATION (KVM)                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - Separate address space (EPT/NPT)                  │   │
│  │  - Trapped privileged instructions                   │   │
│  │  - VMCS/VMCB isolation                               │   │
│  │  - Hardware memory encryption (SEV/TDX optional)     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  LAYER 2: FIRECRACKER VMM                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - Minimal device model (no legacy devices)          │   │
│  │  - Written in Rust (memory safety)                   │   │
│  │  - Seccomp-bpf filtering (< 50 syscalls)            │   │
│  │  - No PCI, no ACPI, no USB                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  LAYER 3: JAILER (Production)                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - chroot isolation                                  │   │
│  │  - User namespace (unprivileged)                     │   │
│  │  - cgroup resource limits                            │   │
│  │  - Seccomp whitelist                                 │   │
│  │  - Dropped capabilities                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  LAYER 4: GUEST ISOLATION                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - No network (default)                              │   │
│  │  - Read-only rootfs (optional)                       │   │
│  │  - Minimal userspace                                 │   │
│  │  - Process isolation via separate VMs               │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Threat Model

```
┌─────────────────────────────────────────────────────────────┐
│                    THREAT SCENARIOS                          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  THREAT: Malicious code execution                    │   │
│  │  MITIGATION:                                         │   │
│  │    - Code runs in isolated VM (separate kernel)      │   │
│  │    - No network access (no C2, no exfil)            │   │
│  │    - Resource limits (CPU, memory, time)             │   │
│  │    - Process killed after timeout                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  THREAT: VM escape                                   │   │
│  │  MITIGATION:                                         │   │
│  │    - Firecracker minimal attack surface              │   │
│  │    - KVM hardware isolation                          │   │
│  │    - Jailer unprivileged execution                   │   │
│  │    - Regular security updates                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  THREAT: Resource exhaustion (DoS)                   │   │
│  │  MITIGATION:                                         │   │
│  │    - Hard timeout on execution                       │   │
│  │    - Memory limit (512 MiB default)                  │   │
│  │    - VM pool with limits                             │   │
│  │    - Rate limiting at control plane                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  THREAT: Data exfiltration                           │   │
│  │  MITIGATION:                                         │   │
│  │    - No network by default                           │   │
│  │    - Stdout/stderr size limits                       │   │
│  │    - No persistent storage across executions         │   │
│  │    - VM destroyed after each job                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Seccomp Profile (Production)

```
Allowed syscalls for Firecracker (example):
  read, write, close, fstat, mmap, mprotect, munmap,
  brk, rt_sigaction, rt_sigprocmask, ioctl, access,
  pipe, dup, dup2, pause, nanosleep, getpid, socket,
  connect, accept, bind, listen, setsockopt, getsockopt,
  clone, fork, execve, exit, wait4, kill, uname,
  fcntl, flock, fsync, fdatasync, rename, mkdir, rmdir,
  creat, unlink, symlink, readlink, chmod, chown,
  lseek, getuid, getgid, geteuid, getegid, getppid,
  setsid, setuid, setgid, getgroups, setgroups,
  clock_gettime, clock_nanosleep, exit_group,
  epoll_create, epoll_ctl, epoll_wait, eventfd2,
  timerfd_create, timerfd_settime, signalfd4

Blocked (high-risk):
  ptrace, personality, mount, umount, pivot_root,
  reboot, sethostname, setdomainname, init_module,
  delete_module, create_module, kexec_load, ...
```

---

## Performance Considerations

### Latency Breakdown

```
┌─────────────────────────────────────────────────────────────┐
│                    COLD START LATENCY                        │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Component              │ Time (typical)            │   │
│  ├─────────────────────────┼───────────────────────────┤   │
│  │  Firecracker process    │  ~5 ms                    │   │
│  │  API configuration      │  ~10 ms                   │   │
│  │  VM boot (kernel)       │  ~100-150 ms              │   │
│  │  Init + guest-runner    │  ~50-100 ms               │   │
│  │  Vsock connection       │  ~5 ms                    │   │
│  ├─────────────────────────┼───────────────────────────┤   │
│  │  TOTAL COLD START       │  ~170-270 ms              │   │
│  └─────────────────────────┴───────────────────────────┘   │
│                                                              │
│                    WARM START (SNAPSHOT)                     │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Component              │ Time (typical)            │   │
│  ├─────────────────────────┼───────────────────────────┤   │
│  │  Firecracker process    │  ~5 ms                    │   │
│  │  Snapshot restore       │  ~5-10 ms                 │   │
│  │  Vsock reconnection     │  ~2 ms                    │   │
│  ├─────────────────────────┼───────────────────────────┤   │
│  │  TOTAL WARM START       │  ~12-17 ms                │   │
│  └─────────────────────────┴───────────────────────────┘   │
│                                                              │
│                    EXECUTION LATENCY                         │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Language    │ Startup    │ Simple print           │   │
│  ├──────────────┼────────────┼────────────────────────┤   │
│  │  Python 3    │  ~30 ms    │  ~35 ms                │   │
│  │  Node.js     │  ~40 ms    │  ~45 ms                │   │
│  │  Ruby        │  ~50 ms    │  ~55 ms                │   │
│  │  Rust (run)  │  ~1 ms     │  ~2 ms                 │   │
│  │  Bash        │  ~2 ms     │  ~3 ms                 │   │
│  └──────────────┴────────────┴────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Memory Footprint

```
┌─────────────────────────────────────────────────────────────┐
│                    MEMORY USAGE                              │
│                                                              │
│  Host-side:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Firecracker process    │  ~5 MiB RSS               │   │
│  │  KVM memory tracking    │  ~1 MiB per VM            │   │
│  │  Host-agent (Go)        │  ~10-20 MiB               │   │
│  └─────────────────────────┴───────────────────────────┘   │
│                                                              │
│  Guest-side (512 MiB VM):                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Kernel                 │  ~20-30 MiB               │   │
│  │  Guest-runner (Go)      │  ~5-10 MiB                │   │
│  │  Python interpreter     │  ~30-50 MiB               │   │
│  │  Node.js interpreter    │  ~40-60 MiB               │   │
│  │  Available for code     │  ~350-400 MiB             │   │
│  └─────────────────────────┴───────────────────────────┘   │
│                                                              │
│  Note: Firecracker uses memory ballooning for efficiency    │
│  Actual host memory = Used guest memory (not allocated)     │
└─────────────────────────────────────────────────────────────┘
```

---

## Memory Layout

### Guest Physical Memory Map

```
┌─────────────────────────────────────────────────────────────┐
│                 GUEST PHYSICAL ADDRESS SPACE                 │
│                      (512 MiB example)                       │
│                                                              │
│  0x0000_0000 ┌──────────────────────────────────────────┐   │
│              │  Real Mode IVT / BDA                      │   │
│  0x0000_1000 ├──────────────────────────────────────────┤   │
│              │  Reserved                                 │   │
│  0x0010_0000 ├──────────────────────────────────────────┤   │
│   (1 MiB)    │  Kernel Load Address                      │   │
│              │  vmlinux (decompressed)                   │   │
│              │  ~10-20 MiB                               │   │
│  0x0200_0000 ├──────────────────────────────────────────┤   │
│   (32 MiB)   │  Kernel Heap / Slab                       │   │
│              │                                           │   │
│  0x1000_0000 ├──────────────────────────────────────────┤   │
│  (256 MiB)   │  User Space Memory                        │   │
│              │  - Guest-runner process                   │   │
│              │  - Spawned interpreters                   │   │
│              │  - Temp files (tmpfs)                     │   │
│              │                                           │   │
│  0x1FFF_FFFF └──────────────────────────────────────────┘   │
│  (512 MiB)                                                   │
│                                                              │
│  MMIO Regions (above RAM):                                   │
│  0x_D000_0000  Serial console (ttyS0)                       │
│  0x_D000_1000  RTC                                          │
│  0x_D000_2000  Virtio devices (blk, vsock, net)             │
└─────────────────────────────────────────────────────────────┘
```

### Vsock Buffer Management

```
┌─────────────────────────────────────────────────────────────┐
│                 VSOCK DATA PATH                              │
│                                                              │
│  HOST                           GUEST                        │
│  ┌─────────────┐               ┌─────────────┐              │
│  │ Application │               │ Application │              │
│  │ (host-agent)│               │(guest-runner│              │
│  └──────┬──────┘               └──────┬──────┘              │
│         │ write()                     │ read()              │
│         ▼                             ▲                      │
│  ┌─────────────┐               ┌─────────────┐              │
│  │  Socket     │               │  Socket     │              │
│  │  Buffer     │               │  Buffer     │              │
│  │  (64 KB)    │               │  (64 KB)    │              │
│  └──────┬──────┘               └──────┴──────┘              │
│         │                             ▲                      │
│         ▼                             │                      │
│  ┌─────────────┐               ┌─────────────┐              │
│  │ vhost-vsock │──────────────>│ virtio-vsock│              │
│  │  (kernel)   │   vring       │  (kernel)   │              │
│  └─────────────┘               └─────────────┘              │
│                                                              │
│  Virtio Ring (vring):                                        │
│  - Descriptor table: 256 entries                            │
│  - Available ring: producer index                           │
│  - Used ring: consumer index                                │
│  - Event suppression for batching                           │
└─────────────────────────────────────────────────────────────┘
```

---

## Execution Flow

### Complete Request Lifecycle

```
┌─────────────────────────────────────────────────────────────┐
│                 COMPLETE EXECUTION FLOW                      │
│                                                              │
│  T+0ms    Client sends RunRequest                           │
│           │                                                  │
│  T+1ms    Host-agent receives request                       │
│           │                                                  │
│  T+2ms    ├── Check VM pool for available instance          │
│           │   └── If none: start new Firecracker            │
│           │                                                  │
│  T+5ms    ├── Start Firecracker process                     │
│           │   └── firecracker --api-sock /tmp/fc-X.sock     │
│           │                                                  │
│  T+10ms   ├── Wait for API socket                           │
│           │                                                  │
│  T+15ms   ├── Configure VM via API                          │
│           │   ├── PUT /machine-config                       │
│           │   ├── PUT /boot-source                          │
│           │   ├── PUT /drives/rootfs                        │
│           │   └── PUT /vsock                                │
│           │                                                  │
│  T+20ms   ├── Start VM                                      │
│           │   └── PUT /actions {InstanceStart}              │
│           │                                                  │
│  T+25ms   ├── VM boot sequence                              │
│           │   ├── Kernel decompression                      │
│           │   ├── Kernel init                               │
│           │   ├── Driver probing (virtio)                   │
│           │   ├── Mount rootfs                              │
│           │   └── Run init process                          │
│           │                                                  │
│  T+150ms  ├── guest-runner starts                           │
│           │   └── vsock.Listen(port=5000)                   │
│           │                                                  │
│  T+155ms  ├── Host-agent connects via vsock                 │
│           │   └── vsock.Dial(CID=3, port=5000)              │
│           │                                                  │
│  T+160ms  ├── Send job (JSON)                               │
│           │   └── {lang: "python", code: "...", timeout: 10}│
│           │                                                  │
│  T+165ms  ├── guest-runner receives job                     │
│           │   ├── Create /tmp/job-XXXXX/                    │
│           │   ├── Write script.py                           │
│           │   └── exec.Command("python3", "script.py")      │
│           │                                                  │
│  T+200ms  ├── Python interpreter starts                     │
│           │   └── Execute user code                         │
│           │                                                  │
│  T+250ms  ├── Execution completes                           │
│           │   ├── Capture stdout/stderr                     │
│           │   ├── Get exit code                             │
│           │   └── Cleanup temp directory                    │
│           │                                                  │
│  T+255ms  ├── Send result (JSON)                            │
│           │   └── {stdout: "...", stderr: "", exit_code: 0} │
│           │                                                  │
│  T+260ms  ├── Host-agent receives result                    │
│           │                                                  │
│  T+265ms  ├── Shutdown VM                                   │
│           │   └── PUT /actions {SendCtrlAltDel}             │
│           │                                                  │
│  T+280ms  └── Return result to client                       │
│                                                              │
│  Total: ~280ms (cold start + simple Python execution)       │
└─────────────────────────────────────────────────────────────┘
```

### Error Handling Flow

```
┌─────────────────────────────────────────────────────────────┐
│                 ERROR HANDLING SCENARIOS                     │
│                                                              │
│  1. VM Boot Failure                                          │
│     ├── Firecracker exits with error                        │
│     ├── Host-agent detects via process monitoring           │
│     └── Return error: "VM boot failed: {reason}"            │
│                                                              │
│  2. Guest-runner Connection Timeout                          │
│     ├── vsock.Dial() times out (30s default)                │
│     ├── Kill VM process                                     │
│     └── Return error: "Guest not ready within timeout"      │
│                                                              │
│  3. Execution Timeout                                        │
│     ├── context.WithTimeout() expires                       │
│     ├── guest-runner kills child process (SIGKILL)          │
│     ├── Return partial stdout/stderr                        │
│     └── exit_code: 124 (timeout)                            │
│                                                              │
│  4. Compilation Error (Rust, Go)                             │
│     ├── Compiler returns non-zero exit                      │
│     ├── Capture compiler stderr                             │
│     └── Return: {stderr: "error[E0308]...", exit_code: 1}   │
│                                                              │
│  5. Runtime Error                                            │
│     ├── Process crashes or throws exception                 │
│     ├── Capture stderr (traceback)                          │
│     └── Return: {stderr: "Traceback...", exit_code: 1}      │
│                                                              │
│  6. Out of Memory                                            │
│     ├── Guest kernel OOM killer activates                   │
│     ├── Process killed with SIGKILL                         │
│     └── Return: {stderr: "Killed", exit_code: 137}          │
└─────────────────────────────────────────────────────────────┘
```
